<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MarcCalc - Dashboard</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; background-color: #f4f4f4; }
        table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        th { background-color: #f2f2f2; font-weight: bold; }
        input { width: 100%; padding: 5px; box-sizing: border-box; }
        .total-cell { background-color: #e9e9e9; }
        button { padding: 8px 16px; margin: 5px; border: none; cursor: pointer; border-radius: 4px; }
        button:hover { opacity: 0.9; }
        #btn-valor-total, .add-line { background-color: #4CAF50; color: white; }
        .btn-salvar { background-color: #2196F3; color: white; }
        .btn-nova { background-color: #FF9800; color: white; }
        .btn-carregar, .btn-renomear { background-color: #9C27B0; color: white; font-size: 0.8em; }
        .btn-excluir { background-color: #f44336; color: white; font-size: 0.8em; }
        #resultado-final { font-size: 18px; font-weight: bold; margin-top: 20px; }
        .valor-materiais { margin: 10px 0; font-weight: bold; }
        .planilhas-salvas { margin-top: 20px; padding: 15px; background: white; border-radius: 8px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
        .planilha-item { display: flex; justify-content: space-between; align-items: center; padding: 8px; border-bottom: 1px solid #eee; }
        .planilha-item:last-child { border-bottom: none; }
        .planilha-nome { font-weight: bold; }
        .input-nome { width: 150px; padding: 4px; font-size: 0.9em; }
    </style>
</head>
<body>
    <h1>MarcCalc - Dashboard</h1>


    <h2>Orçamento de Custos</h2>

    <table id="tabela-orcamento">
        <thead>
            <tr>
                <th>Materiais</th>
                <th>Quantidade</th>
                <th>Valor Unitário</th>
                <th>Total</th>
            </tr>
        </thead>
        <tbody id="tabela-body"></tbody>
    </table>

    <button id="btn-valor-total">VALOR TOTAL</button>
    <button class="add-line" onclick="adicionarLinha()">+ Adicionar Linha</button>
    <button class="btn-salvar" onclick="salvarComoJSON()">Salvar como JSON</button>
    <button class="btn-nova" onclick="novaPlanilha()">Nova Planilha</button>

    <!-- Upload para abrir JSON -->
    <input type="file" id="file-input" accept=".json" style="display:none;" onchange="abrirJSON(event)">
    <button onclick="document.getElementById('file-input').click()" style="background:#555;color:white;">Abrir JSON</button>

    <div class="valor-materiais" id="valor-materiais">Valor Materiais: R$ 0.00</div>

    <label for="margem-lucro">Margem de Lucro (%):</label>
    <input type="number" id="margem-lucro" placeholder="Ex: 20" step="0.01">

    <label for="dias">Dias de Produção:</label>
    <input type="number" id="dias" placeholder="Ex: 5" min="0" step="1">

    <label for="diaria">Custo Diário:</label>
    <input type="number" id="diaria" placeholder="Ex: 100.00" step="0.01">

    <div id="resultado-final">Resultado Final: R$ 0.00</div>

    <!-- Lista de Planilhas Salvas no Navegador -->
<div class="planilhas-salvas">
    <h3>Planilhas Salvas no Navegador</h3>
    <div id="lista-planilhas">Nenhuma planilha salva ainda.</div>
</div>

    <script>
    // === ELEMENTOS ===
    const tabelaBody = document.getElementById('tabela-body');
    const btnValorTotal = document.getElementById('btn-valor-total');
    const diasInput = document.getElementById('dias');
    const diariaInput = document.getElementById('diaria');
    const margemLucroInput = document.getElementById('margem-lucro');
    const resultadoFinal = document.getElementById('resultado-final');
    const valorMateriaisDiv = document.getElementById('valor-materiais');
    const listaPlanilhas = document.getElementById('lista-planilhas');

    const PLANILHAS_KEY = 'marccalc_planilhas';
    let planilhasSalvas = JSON.parse(localStorage.getItem(PLANILHAS_KEY)) || {};
    let planilhaAtualId = null;

    // === FUNÇÕES BÁSICAS ===
    function formatarMoeda(valor) {
        return `R$ ${valor.toFixed(2).replace('.', ',').replace(/\B(?=(\d{3})+(?!\d))/g, '.')}`;
    }

    function adicionarLinha(material = '', qty = '', unit = '') {
        const row = document.createElement('tr');

        const inputs = [
            criarInput('text', 'Material', material),
            criarInput('number', 'Qty', qty, '0.01'),
            criarInput('number', 'Unit.', unit, '0.01')
        ];

        const cellTotal = document.createElement('td');
        cellTotal.classList.add('total-cell');
        cellTotal.textContent = 'R$ 0.00';

        const calcular = () => {
            const q = parseFloat(inputs[1].value) || 0;
            const u = parseFloat(inputs[2].value) || 0;
            cellTotal.textContent = formatarMoeda(q * u);
            updateValorMateriais();
            salvarPlanilhaAtual();
        };

        inputs.forEach(i => i.addEventListener('input', () => { calcular(); salvarPlanilhaAtual(); }));

        inputs.forEach(input => {
            const td = document.createElement('td');
            td.appendChild(input);
            row.appendChild(td);
        });
        row.appendChild(cellTotal);
        tabelaBody.appendChild(row);

        if (qty && unit) calcular();
    }

    function criarInput(type, placeholder, value, step) {
        const input = document.createElement('input');
        input.type = type;
        input.placeholder = placeholder;
        input.value = value;
        if (step) input.step = step;
        return input;
    }

    // === INICIAR COM 3 LINHAS ===
    for (let i = 0; i < 3; i++) adicionarLinha();

    // === ATUALIZAÇÕES ===
    function updateValorMateriais() {
        let total = 0;
        document.querySelectorAll('.total-cell').forEach(cell => {
            const text = cell.textContent.replace('R$ ', '').replace('.', '').replace(',', '.').trim();
            total += parseFloat(text) || 0;
        });
        valorMateriaisDiv.textContent = `Valor Materiais: ${formatarMoeda(total)}`;
        recalcularTotal();
    }

    function recalcularTotal() {
        let totalMateriais = 0;
        document.querySelectorAll('.total-cell').forEach(cell => {
            const text = cell.textContent.replace('R$ ', '').replace('.', '').replace(',', '.').trim();
            totalMateriais += parseFloat(text) || 0;
        });

        const dias = parseInt(diasInput.value) || 0;
        const diaria = parseFloat(diariaInput.value) || 0;
        const totalDiaria = dias * diaria;
        const margemLucro = parseFloat(margemLucroInput.value) || 0;
        const base = totalMateriais + totalDiaria;
        const valorMargem = base * (margemLucro / 100);
        const final = base + valorMargem;

        resultadoFinal.textContent = `Resultado Final: ${formatarMoeda(final)}`;
    }

    // === EVENTOS PRINCIPAIS ===
    btnValorTotal.addEventListener('click', recalcularTotal);
    diasInput.addEventListener('input', () => { recalcularTotal(); salvarPlanilhaAtual(); });
    diariaInput.addEventListener('input', () => { recalcularTotal(); salvarPlanilhaAtual(); });
    margemLucroInput.addEventListener('input', () => { recalcularTotal(); salvarPlanilhaAtual(); });

    // === LOCALSTORAGE: SALVAR, CARREGAR, LISTAR ===

    function salvarPlanilhaAtual() {
        if (!planilhaAtualId) {
            planilhaAtualId = 'planilha_' + Date.now();
        }

        const dados = {
            id: planilhaAtualId,
            nome: planilhasSalvas[planilhaAtualId]?.nome || `Orçamento ${new Date().toLocaleDateString()}`,
            data: new Date().toISOString(),
            materiais: [],
            diasProducao: diasInput.value,
            custoDiario: diariaInput.value,
            margemLucro: margemLucroInput.value
        };

        tabelaBody.querySelectorAll('tr').forEach(row => {
            const inputs = row.querySelectorAll('input');
            dados.materiais.push({
                nome: inputs[0].value,
                quantidade: inputs[1].value,
                valorUnitario: inputs[2].value
            });
        });

        planilhasSalvas[planilhaAtualId] = dados;
        localStorage.setItem(PLANILHAS_KEY, JSON.stringify(planilhasSalvas));
        atualizarListaPlanilhas();
    }

    function carregarPlanilha(id) {
        const dados = planilhasSalvas[id];
        if (!dados) return;

        planilhaAtualId = id;
        tabelaBody.innerHTML = '';
        dados.materiais.forEach(m => adicionarLinha(m.nome, m.quantidade, m.valorUnitario));
        diasInput.value = dados.diasProducao;
        diariaInput.value = dados.custoDiario;
        margemLucroInput.value = dados.margemLucro;
        updateValorMateriais();
        recalcularTotal();
        atualizarListaPlanilhas();
    }

    function excluirPlanilha(id) {
        if (confirm('Tem certeza que deseja excluir esta planilha?')) {
            delete planilhasSalvas[id];
            localStorage.setItem(PLANILHAS_KEY, JSON.stringify(planilhasSalvas));
            if (planilhaAtualId === id) {
                planilhaAtualId = null;
                novaPlanilha();
            }
            atualizarListaPlanilhas();
        }
    }

    function atualizarListaPlanilhas() {
        if (Object.keys(planilhasSalvas).length === 0) {
            listaPlanilhas.innerHTML = '<em>Nenhuma planilha salva ainda.</em>';
            return;
        }

        const itens = Object.values(planilhasSalvas)
            .sort((a, b) => new Date(b.data) - new Date(a.data))
            .map(p => {
                const ativo = p.id === planilhaAtualId ? ' (ATIVA)' : '';
                return `
                    <div class="planilha-item" id="item-${p.id}">
                        <div style="flex:1;">
                            <span class="planilha-nome" id="nome-${p.id}" style="font-weight:bold;">${p.nome}</span>${ativo}
                            <div id="edit-${p.id}" style="display:none; margin-top:5px;">
                                <input type="text" class="input-nome" value="${p.nome}" id="input-${p.id}">
                                <button class="btn-salvar-nome" onclick="salvarNome('${p.id}')" style="background:#4CAF50; color:white; font-size:0.8em; padding:2px 6px;">Salvar</button>
                                <button onclick="cancelarEdicao('${p.id}')" style="background:#999; color:white; font-size:0.8em; padding:2px 6px;">Cancelar</button>
                            </div>
                        </div>
                        <div>
                            <button class="btn-carregar" onclick="carregarPlanilha('${p.id}')">Carregar</button>
                            <button class="btn-renomear" onclick="iniciarEdicao('${p.id}')" style="background:#9C27B0; color:white; font-size:0.8em;">Renomear</button>
                            <button class="btn-excluir" onclick="excluirPlanilha('${p.id}')">Excluir</button>
                        </div>
                    </div>
                `;
            }).join('');

        listaPlanilhas.innerHTML = itens;
    }

    // === EDIÇÃO DE NOME ===
    function iniciarEdicao(id) {
        document.getElementById(`nome-${id}`).style.display = 'none';
        document.getElementById(`edit-${id}`).style.display = 'block';
        document.getElementById(`input-${id}`).focus();
    }

    function salvarNome(id) {
        const input = document.getElementById(`input-${id}`);
        const novoNome = input.value.trim();
        if (novoNome) {
            planilhasSalvas[id].nome = novoNome;
            localStorage.setItem(PLANILHAS_KEY, JSON.stringify(planilhasSalvas));
            atualizarListaPlanilhas();
        } else {
            alert('O nome não pode estar vazio.');
        }
    }

    function cancelarEdicao(id) {
        document.getElementById(`nome-${id}`).style.display = 'inline';
        document.getElementById(`edit-${id}`).style.display = 'none';
    }

    // === SALVAR COMO JSON (DOWNLOAD) ===
    function salvarComoJSON() {
        salvarPlanilhaAtual();
        const dados = planilhasSalvas[planilhaAtualId];
        const json = JSON.stringify(dados, null, 2);
        const blob = new Blob([json], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `${dados.nome.replace(/[^a-z0-9]/gi, '_')}_${new Date().toISOString().slice(0,10)}.json`;
        a.click();
        URL.revokeObjectURL(url);
    }

    // === ABRIR JSON (UPLOAD) ===
    function abrirJSON(event) {
        const file = event.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const dados = JSON.parse(e.target.result);
                planilhaAtualId = 'upload_' + Date.now();
                planilhasSalvas[planilhaAtualId] = {
                    ...dados,
                    id: planilhaAtualId,
                    nome: dados.nome || 'Planilha Importada',
                    data: new Date().toISOString()
                };
                localStorage.setItem(PLANILHAS_KEY, JSON.stringify(planilhasSalvas));
                carregarPlanilha(planilhaAtualId);
                alert('Planilha importada com sucesso!');
            } catch (err) {
                alert('Erro: Arquivo JSON inválido.');
            }
        };
        reader.readAsText(file);
    }

    function novaPlanilha() {
        if (confirm('Limpar tudo e começar uma nova planilha?')) {
            planilhaAtualId = null;
            tabelaBody.innerHTML = '';
            for (let i = 0; i < 3; i++) adicionarLinha();
            diasInput.value = '';
            diariaInput.value = '';
            margemLucroInput.value = '';
            updateValorMateriais();
            recalcularTotal();
        }
    }

    // === SALVAR AO PRESSIONAR ENTER / ESC ===
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Enter' && e.target.classList.contains('input-nome')) {
            const id = e.target.id.replace('input-', '');
            salvarNome(id);
        }
        if (e.key === 'Escape' && e.target.classList.contains('input-nome')) {
            const id = e.target.id.replace('input-', '');
            cancelarEdicao(id);
        }
    });

    // === INICIAR ===
    atualizarListaPlanilhas();
    salvarPlanilhaAtual();
</script>
</body>
</html>

