<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MarcCalc Pro - Sistema Integrado</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
        body { font-family: 'Inter', sans-serif; }
        /* Remove setas do input number */
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        input:focus { outline: none; border-color: #6366f1; box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.2); }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 h-screen overflow-hidden flex flex-col">

    <div id="view-login" class="fixed inset-0 z-50 bg-slate-900 flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-sm rounded-2xl shadow-2xl overflow-hidden">
            <div class="bg-indigo-600 p-8 text-center">
                <div class="inline-flex bg-white/20 p-3 rounded-xl mb-4 text-white">
                    <i class="ph-bold ph-lock-key text-3xl"></i>
                </div>
                <h1 class="text-2xl font-bold text-white">MarcCalc Pro</h1>
                <p class="text-indigo-100 text-sm mt-1">Validação de Licença</p>
            </div>
            
            <div class="p-8 space-y-4">
                <div id="msg-erro" class="hidden bg-red-50 text-red-600 text-xs p-3 rounded-lg border border-red-100 text-center font-medium"></div>

                <div>
                    <label class="block text-xs font-bold text-slate-500 mb-1 uppercase">Email</label>
                    <input type="email" id="email" class="w-full border-slate-300 border rounded-xl px-4 py-3 focus:border-indigo-500 transition-all">
                </div>
                <div>
                    <label class="block text-xs font-bold text-slate-500 mb-1 uppercase">Senha</label>
                    <input type="password" id="password" class="w-full border-slate-300 border rounded-xl px-4 py-3 focus:border-indigo-500 transition-all">
                </div>
                
                <button id="btn-login-action" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3.5 rounded-xl shadow-lg shadow-indigo-200 transition-all active:scale-95 flex items-center justify-center gap-2">
                    <span id="btn-text">AUTENTICAR DISPOSITIVO</span>
                    <i class="ph-bold ph-arrow-right"></i>
                </button>
            </div>
        </div>
    </div>

    <div id="view-app" class="flex flex-col h-full hidden">
        <nav class="bg-white border-b border-slate-200 flex-none z-10">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between h-16 items-center">
                    <div class="flex items-center gap-2">
                        <div class="bg-indigo-600 text-white p-1.5 rounded-lg shadow-sm">
                            <i class="ph-bold ph-calculator text-xl"></i>
                        </div>
                        <span class="font-bold text-xl text-slate-900">MarcCalc</span>
                    </div>
                    <div class="flex items-center gap-3">
                        <button id="btn-novo" class="hidden sm:flex items-center gap-1 text-sm font-medium text-slate-500 hover:text-indigo-600 transition">
                            <i class="ph-bold ph-plus-circle"></i> Novo
                        </button>
                        <div class="h-6 w-px bg-slate-200 mx-1 hidden sm:block"></div>
                        <button id="btn-meus-devices" class="text-xs font-bold text-slate-600 hover:text-indigo-600 px-3 py-1.5 rounded-lg border border-slate-200 flex items-center gap-2">
                            <i class="ph-bold ph-desktop"></i> Meus Dispositivos
                        </button>
                        <button id="btn-logout" class="text-xs font-bold text-red-500 hover:text-red-700 hover:bg-red-50 px-3 py-1.5 rounded-lg border border-red-100">
                            SAIR
                        </button>
                    </div>
                </div>
            </div>
        </nav>

        <main class="flex-1 overflow-y-auto bg-slate-50">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                    <div class="lg:col-span-2 space-y-6">
                        <div class="bg-white rounded-xl shadow-sm border border-slate-100 overflow-hidden">
                            <div class="p-5 border-b border-slate-100 flex justify-between items-center bg-white sticky top-0 z-10">
                                <h2 class="text-lg font-semibold text-slate-800 flex items-center gap-2">
                                    <i class="ph-duotone ph-package text-indigo-500"></i> Materiais
                                </h2>
                                <div id="valor-materiais" class="text-sm font-bold text-slate-700 bg-slate-100 px-3 py-1.5 rounded-lg">R$ 0,00</div>
                            </div>
                            <div class="p-6">
                                <table class="w-full text-left border-collapse">
                                    <thead>
                                        <tr class="text-xs font-bold text-slate-400 uppercase tracking-wider border-b border-slate-100">
                                            <th class="pb-3 pl-1 w-1/2">Item</th>
                                            <th class="pb-3 w-20 text-center">Qtd.</th>
                                            <th class="pb-3 w-28">Valor Unit.</th>
                                            <th class="pb-3 w-28 text-right">Total</th>
                                            <th class="pb-3 w-10"></th>
                                        </tr>
                                    </thead>
                                    <tbody id="tabela-body" class="text-sm"></tbody>
                                </table>
                                <button id="btn-add-linha" class="mt-6 flex items-center gap-2 text-sm font-medium text-indigo-600 hover:text-indigo-700 hover:bg-indigo-50 px-4 py-3 rounded-xl transition-all w-full justify-center border border-dashed border-indigo-200">
                                    <i class="ph-bold ph-plus"></i> Adicionar Novo Material
                                </button>
                            </div>
                        </div>
                        <div>
                            <h3 class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-3 ml-1">Orçamentos Salvos</h3>
                            <div id="lista-planilhas" class="grid grid-cols-1 md:grid-cols-2 gap-3"></div>
                        </div>
                    </div>

                    <div class="lg:col-span-1">
                        <div class="bg-white rounded-xl shadow-lg border border-indigo-50 p-6 sticky top-6">
                            <h2 class="text-lg font-semibold text-slate-900 mb-6 flex items-center gap-2">
                                <i class="ph-duotone ph-sliders-horizontal text-indigo-500"></i> Configuração
                            </h2>
                            <div class="space-y-5">
                                <div>
                                    <label class="block text-xs font-bold text-slate-500 mb-1.5 uppercase">Nome do Projeto</label>
                                    <input type="text" id="nome-orcamento" class="w-full border-slate-200 border rounded-lg px-4 py-3 text-slate-900 font-semibold focus:ring-2 focus:ring-indigo-500 bg-slate-50">
                                </div>
                                <div>
                                    <label class="block text-xs font-bold text-slate-500 mb-1.5 uppercase">Margem de Lucro</label>
                                    <div class="relative group">
                                        <input type="number" id="margem-lucro" placeholder="20" class="w-full border-slate-200 border rounded-lg px-4 py-3 text-slate-900 font-semibold focus:ring-2 focus:ring-indigo-500 bg-slate-50">
                                        <div class="absolute inset-y-0 right-0 pr-4 flex items-center pointer-events-none text-slate-400 font-bold">%</div>
                                    </div>
                                </div>
                                <div class="grid grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-xs font-bold text-slate-500 mb-1.5 uppercase">Dias Prod.</label>
                                        <input type="number" id="dias" placeholder="5" class="w-full border-slate-200 border rounded-lg px-4 py-3 text-slate-900 font-semibold text-center bg-slate-50">
                                    </div>
                                    <div>
                                        <label class="block text-xs font-bold text-slate-500 mb-1.5 uppercase">Custo Dia</label>
                                        <input type="number" id="diaria" placeholder="100" class="w-full border-slate-200 border rounded-lg px-3 py-3 text-slate-900 font-semibold text-right bg-slate-50">
                                    </div>
                                </div>
                                <hr class="border-slate-100 my-2">
                                <div class="text-center bg-indigo-600 rounded-xl p-6 shadow-lg shadow-indigo-200 text-white relative overflow-hidden group">
                                    <span class="relative block text-indigo-100 text-sm font-medium mb-1">Preço Final Sugerido</span>
                                    <span id="resultado-final-valor" class="relative block text-4xl font-extrabold tracking-tight">R$ 0,00</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <div id="modal-devices" class="hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-md rounded-2xl p-6 shadow-2xl">
            <div class="flex justify-between items-center mb-4 border-b border-slate-100 pb-4">
                <h3 class="font-bold text-lg text-slate-800">Gerenciar Licenças</h3>
                <button id="btn-close-modal" class="text-slate-400 hover:text-slate-600"><i class="ph-bold ph-x text-xl"></i></button>
            </div>
            <div id="lista-devices-container" class="space-y-3 mb-4 max-h-60 overflow-y-auto"></div>
            <p class="text-xs text-slate-400 text-center bg-slate-50 p-3 rounded-lg">Remova dispositivos antigos para liberar vagas.</p>
        </div>
    </div>

    <script>
        // --- 1. CONFIGURAÇÃO SUPABASE ---
        // IMPORTANTE: Substitua abaixo pelas suas chaves do Supabase
        const SUPABASE_URL = 'https://yupqupqjflmqhwjroaio.supabase.co'; 
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inl1cHF1cHFqZmxtcWh3anJvYWlvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjYxMDQyNDQsImV4cCI6MjA4MTY4MDI0NH0.EMF1j36peTGEFHZ1rj3DqOMRujPBpZkiBaz0W7RJkRM';
        
        // Verifica se o Supabase carregou
        if (typeof supabase === 'undefined') {
            alert("Erro crítico: A biblioteca do Supabase não carregou. Verifique sua conexão com a internet.");
        }

        const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        // --- 2. VARIAVEIS GLOBAIS ---
        let deviceToken = localStorage.getItem('marccalc_device_token');
        if (!deviceToken) {
            deviceToken = crypto.randomUUID();
            localStorage.setItem('marccalc_device_token', deviceToken);
        }

        const PLANILHAS_KEY = 'marccalc_planilhas';
        let planilhasSalvas = JSON.parse(localStorage.getItem(PLANILHAS_KEY)) || {};
        let planilhaAtualId = null;

        // Elementos DOM
        const viewLogin = document.getElementById('view-login');
        const viewApp = document.getElementById('view-app');
        const msgErro = document.getElementById('msg-erro');
        const btnLoginAction = document.getElementById('btn-login-action');
        const tabelaBody = document.getElementById('tabela-body');
        
        // --- 3. FUNÇÕES DE AUTENTICAÇÃO ---
        async function tentarLogin() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            let deviceName = `Dispositivo ${new Date().toLocaleDateString('pt-BR')}`;

            if(!email || !password) return mostrarErro("Preencha todos os campos.");

            msgErro.classList.add('hidden');
            btnLoginAction.disabled = true;
            document.getElementById('btn-text').textContent = "VERIFICANDO...";

            try {
                // 1. Login
                const { data: authData, error: authError } = await sb.auth.signInWithPassword({ email, password });
                if (authError) throw new Error("Email ou senha inválidos.");

                const userId = authData.user.id;

                // 2. Licenciamento
                const { data: devices, error: devError } = await sb.from('user_devices').select('*').eq('user_id', userId);
                if(devError) throw devError;

                const isAuthorized = devices.find(d => d.device_token === deviceToken);
                
                if (isAuthorized) {
                    mostrarApp();
                    return;
                }

                // Checa Limite
                const { data: profile } = await sb.from('profiles').select('max_devices').eq('id', userId).single();
                // Se não tiver perfil, assume 1 (falha segura)
                const maxDevices = profile ? profile.max_devices : 1;

                if (devices.length >= maxDevices) {
                    await sb.auth.signOut();
                    throw new Error(`Limite de licenças atingido (${devices.length}/${maxDevices}).`);
                }

                // Cadastra novo
                const { error: insertError } = await sb.from('user_devices').insert({
                    user_id: userId,
                    device_token: deviceToken,
                    device_name: deviceName
                });

                if (insertError) throw insertError;
                mostrarApp();

            } catch (err) {
                console.error(err);
                mostrarErro(err.message || "Erro desconhecido.");
                await sb.auth.signOut();
                resetBtn();
            }
        }

        function mostrarErro(msg) {
            msgErro.textContent = msg;
            msgErro.classList.remove('hidden');
            resetBtn();
        }

        function resetBtn() {
            btnLoginAction.disabled = false;
            document.getElementById('btn-text').textContent = "AUTENTICAR DISPOSITIVO";
        }

        async function init() {
            const { data: { session } } = await sb.auth.getSession();
            if (session) {
                // Valida se token ainda existe no banco
                const { data: dev } = await sb.from('user_devices')
                    .select('id')
                    .eq('user_id', session.user.id)
                    .eq('device_token', deviceToken)
                    .single();
                
                if (dev) mostrarApp();
                else {
                    await sb.auth.signOut();
                    viewLogin.classList.remove('hidden');
                }
            } else {
                viewLogin.classList.remove('hidden');
            }
        }

        async function logout() {
            await sb.auth.signOut();
            window.location.reload();
        }

        // --- 4. CALCULADORA & UI ---
        function mostrarApp() {
            viewLogin.classList.add('hidden');
            viewApp.classList.remove('hidden');
            atualizarListaPlanilhas();
            if(Object.keys(planilhasSalvas).length === 0 && !planilhaAtualId) {
                novaPlanilha();
            }
        }

        function formatarMoeda(valor) {
            return `R$ ${valor.toFixed(2).replace('.', ',').replace(/\B(?=(\d{3})+(?!\d))/g, '.')}`;
        }

        function adicionarLinha(material = '', qty = '', unit = '') {
            const tr = document.createElement('tr');
            tr.className = "group hover:bg-slate-50 border-b border-slate-50";
            tr.innerHTML = `
                <td class="py-2 pr-2 pl-1"><input type="text" value="${material}" class="input-material w-full border border-slate-200 rounded-lg px-3 py-2 text-sm"></td>
                <td class="py-2 pr-2"><input type="number" value="${qty}" class="input-qty w-full border border-slate-200 rounded-lg px-2 py-2 text-center text-sm"></td>
                <td class="py-2 pr-2"><input type="number" step="0.01" value="${unit}" class="input-unit w-full border border-slate-200 rounded-lg px-3 py-2 text-sm"></td>
                <td class="py-2 text-right font-medium text-sm total-cell">R$ 0,00</td>
                <td class="py-2 text-right"><button class="btn-remove text-slate-300 hover:text-red-500"><i class="ph-bold ph-trash"></i></button></td>
            `;

            // Listeners da Linha
            const inputs = tr.querySelectorAll('input');
            inputs.forEach(input => input.addEventListener('input', () => {
                calcularLinha(tr);
                updateGeral();
            }));

            tr.querySelector('.btn-remove').addEventListener('click', () => {
                tr.remove();
                updateGeral();
            });

            tabelaBody.appendChild(tr);
            if(qty && unit) calcularLinha(tr);
        }

        function calcularLinha(tr) {
            const q = parseFloat(tr.querySelector('.input-qty').value) || 0;
            const u = parseFloat(tr.querySelector('.input-unit').value) || 0;
            const total = q * u;
            const cell = tr.querySelector('.total-cell');
            cell.textContent = formatarMoeda(total);
            cell.dataset.value = total;
        }

        function updateGeral() {
            let totalMat = 0;
            document.querySelectorAll('.total-cell').forEach(c => totalMat += parseFloat(c.dataset.value) || 0);
            document.getElementById('valor-materiais').textContent = formatarMoeda(totalMat);

            const dias = parseFloat(document.getElementById('dias').value) || 0;
            const diaria = parseFloat(document.getElementById('diaria').value) || 0;
            const margem = parseFloat(document.getElementById('margem-lucro').value) || 0;

            const custo = totalMat + (dias * diaria);
            const final = custo + (custo * (margem / 100));

            document.getElementById('resultado-final-valor').textContent = formatarMoeda(final);
            salvarAutomatico();
        }

        function salvarAutomatico() {
            if (!planilhaAtualId) planilhaAtualId = 'planilha_' + Date.now();
            
            const nome = document.getElementById('nome-orcamento').value || "Orçamento Sem Nome";
            const dados = {
                id: planilhaAtualId,
                nome: nome,
                data: new Date().toISOString(),
                dias: document.getElementById('dias').value,
                diaria: document.getElementById('diaria').value,
                margem: document.getElementById('margem-lucro').value,
                materiais: []
            };

            document.querySelectorAll('#tabela-body tr').forEach(tr => {
                dados.materiais.push({
                    nome: tr.querySelector('.input-material').value,
                    qtd: tr.querySelector('.input-qty').value,
                    unit: tr.querySelector('.input-unit').value
                });
            });

            planilhasSalvas[planilhaAtualId] = dados;
            localStorage.setItem(PLANILHAS_KEY, JSON.stringify(planilhasSalvas));
            atualizarListaPlanilhas();
        }

        function novaPlanilha() {
            tabelaBody.innerHTML = '';
            ['dias', 'diaria', 'margem-lucro', 'nome-orcamento'].forEach(id => document.getElementById(id).value = '');
            document.getElementById('resultado-final-valor').textContent = 'R$ 0,00';
            document.getElementById('valor-materiais').textContent = 'R$ 0,00';
            planilhaAtualId = null;
            for(let i=0; i<3; i++) adicionarLinha();
        }

        function carregarPlanilha(id) {
            const p = planilhasSalvas[id];
            if(!p) return;
            planilhaAtualId = id;
            tabelaBody.innerHTML = '';
            document.getElementById('nome-orcamento').value = p.nome;
            document.getElementById('dias').value = p.dias;
            document.getElementById('diaria').value = p.diaria;
            document.getElementById('margem-lucro').value = p.margem;
            
            if(p.materiais && p.materiais.length) {
                p.materiais.forEach(m => adicionarLinha(m.nome, m.qtd, m.unit));
            } else {
                adicionarLinha();
            }
            updateGeral();
        }

        function excluirPlanilha(id) {
            if(confirm("Excluir orçamento?")) {
                delete planilhasSalvas[id];
                localStorage.setItem(PLANILHAS_KEY, JSON.stringify(planilhasSalvas));
                if(planilhaAtualId === id) novaPlanilha();
                atualizarListaPlanilhas();
            }
        }

        function atualizarListaPlanilhas() {
            const container = document.getElementById('lista-planilhas');
            container.innerHTML = '';
            Object.values(planilhasSalvas)
                .sort((a,b) => new Date(b.data) - new Date(a.data))
                .forEach(p => {
                    const div = document.createElement('div');
                    const isAtiva = p.id === planilhaAtualId;
                    div.className = `p-3 rounded-xl border cursor-pointer flex justify-between items-center ${isAtiva ? 'border-indigo-500 bg-indigo-50' : 'border-slate-200 bg-white'}`;
                    div.innerHTML = `
                        <div onclick="carregarPlanilha('${p.id}')" class="flex-1">
                            <div class="font-bold text-sm">${p.nome}</div>
                            <div class="text-xs text-slate-500">${new Date(p.data).toLocaleDateString()}</div>
                        </div>
                        <button class="btn-del-planilha text-slate-300 hover:text-red-500 p-2"><i class="ph-bold ph-trash"></i></button>
                    `;
                    div.querySelector('.btn-del-planilha').onclick = (e) => { e.stopPropagation(); excluirPlanilha(p.id); };
                    container.appendChild(div);
                });
        }

        // --- 5. GERENCIADOR DE DISPOSITIVOS ---
        async function abrirGerenciador() {
            const modal = document.getElementById('modal-devices');
            const lista = document.getElementById('lista-devices-container');
            lista.innerHTML = '<div class="text-center text-sm text-slate-400">Carregando...</div>';
            modal.classList.remove('hidden');

            const { data: { user } } = await sb.auth.getUser();
            const { data: devices } = await sb.from('user_devices').select('*').eq('user_id', user.id);
            
            lista.innerHTML = '';
            devices.forEach(d => {
                const isMe = d.device_token === deviceToken;
                const div = document.createElement('div');
                div.className = `flex justify-between items-center p-3 border rounded-lg ${isMe ? 'bg-indigo-50 border-indigo-200' : 'bg-white border-slate-100'}`;
                div.innerHTML = `
                    <div>
                        <div class="text-sm font-bold text-slate-700">${d.device_name || 'Sem nome'} ${isMe ? '(Atual)' : ''}</div>
                        <div class="text-xs text-slate-400">${new Date(d.created_at).toLocaleDateString()}</div>
                    </div>
                    ${!isMe ? `<button class="text-red-400 hover:text-red-600 p-2"><i class="ph-bold ph-trash"></i></button>` : ''}
                `;
                if(!isMe) {
                    div.querySelector('button').onclick = async () => {
                        if(confirm("Remover acesso deste dispositivo?")) {
                            await sb.from('user_devices').delete().eq('id', d.id);
                            abrirGerenciador();
                        }
                    };
                }
                lista.appendChild(div);
            });
        }

        // --- 6. EVENT LISTENERS (Aqui garantimos que o JS funciona) ---
        document.addEventListener('DOMContentLoaded', () => {
            // Listeners de Login
            btnLoginAction.addEventListener('click', tentarLogin);
            
            // Listeners App
            document.getElementById('btn-novo').addEventListener('click', novaPlanilha);
            document.getElementById('btn-logout').addEventListener('click', logout);
            document.getElementById('btn-add-linha').addEventListener('click', () => adicionarLinha());
            
            // Listeners Inputs Globais
            ['nome-orcamento', 'margem-lucro', 'dias', 'diaria'].forEach(id => {
                document.getElementById(id).addEventListener('input', updateGeral);
            });

            // Modal
            document.getElementById('btn-meus-devices').addEventListener('click', abrirGerenciador);
            document.getElementById('btn-close-modal').addEventListener('click', () => {
                document.getElementById('modal-devices').classList.add('hidden');
            });

            // Inicializa
            init();
        });

    </script>
</body>
</html>
