<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MarcCalc Pro - Cloud Sync</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
        body { font-family: 'Inter', sans-serif; }
        
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        
        input:focus { outline: none; border-color: #6366f1; box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.2); }
        
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f5f9; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        
        /* Spinner de Carregamento */
        .loader {
            border: 2px solid #f3f3f3;
            border-top: 2px solid #6366f1;
            border-radius: 50%;
            width: 16px;
            height: 16px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 h-screen supports-[height:100dvh]:h-[100dvh] overflow-hidden flex flex-col">

    <div id="view-login" class="fixed inset-0 z-50 bg-slate-900 flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-sm rounded-2xl shadow-2xl overflow-hidden">
            <div class="bg-indigo-600 p-8 text-center">
                <div class="inline-flex bg-white/20 p-3 rounded-xl mb-4 text-white">
                    <i class="ph-bold ph-lock-key text-3xl"></i>
                </div>
                <h1 class="text-2xl font-bold text-white">MarcCalc Pro</h1>
                <p class="text-indigo-100 text-sm mt-1">Sincronizado na Nuvem</p>
            </div>
            
            <div class="p-6 sm:p-8 space-y-4">
                <div id="msg-erro" class="hidden bg-red-50 text-red-600 text-xs p-3 rounded-lg border border-red-100 text-center font-medium"></div>

                <div>
                    <label class="block text-xs font-bold text-slate-500 mb-1 uppercase">Email</label>
                    <input type="email" id="email" class="w-full border-slate-300 border rounded-xl px-4 py-3 focus:border-indigo-500 transition-all">
                </div>
                <div>
                    <label class="block text-xs font-bold text-slate-500 mb-1 uppercase">Senha</label>
                    <input type="password" id="password" class="w-full border-slate-300 border rounded-xl px-4 py-3 focus:border-indigo-500 transition-all">
                </div>
                
                <button id="btn-login-action" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3.5 rounded-xl shadow-lg shadow-indigo-200 transition-all active:scale-95 flex items-center justify-center gap-2">
                    <span id="btn-text">ENTRAR</span>
                </button>
            </div>
        </div>
    </div>

    <div id="view-app" class="flex flex-col h-full hidden relative">
        
        <nav class="bg-white border-b border-slate-200 flex-none z-10">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between h-16 items-center">
                    <div class="flex items-center gap-4">
                        <div class="flex items-center gap-2">
                            <div class="bg-indigo-600 text-white p-1.5 rounded-lg shadow-sm">
                                <i class="ph-bold ph-cloud-check text-xl"></i>
                            </div>
                            <span class="font-bold text-xl text-slate-900 hidden sm:block">MarcCalc</span>
                        </div>
                        <div class="h-8 w-px bg-slate-200 hidden sm:block"></div>
                        <button id="btn-abrir-catalogo" class="flex items-center gap-2 bg-indigo-50 text-indigo-700 px-3 py-1.5 rounded-lg border border-indigo-100 hover:bg-indigo-100 transition text-sm font-semibold">
                            <i class="ph-bold ph-book-open"></i> <span class="hidden sm:inline">Catálogo</span>
                        </button>
                    </div>

                    <div class="flex items-center gap-2 sm:gap-3">
                        <button id="btn-novo" class="flex items-center gap-1 text-sm font-medium text-slate-500 hover:text-indigo-600 transition p-2 sm:p-0">
                            <i class="ph-bold ph-plus-circle text-xl sm:text-base"></i> <span class="hidden sm:inline">Novo</span>
                        </button>
                        <div class="h-6 w-px bg-slate-200 mx-1 hidden sm:block"></div>
                        <button id="btn-logout" class="text-xs font-bold text-red-500 hover:text-red-700 hover:bg-red-50 px-3 py-1.5 rounded-lg border border-red-100">SAIR</button>
                    </div>
                </div>
            </div>
        </nav>

        <main class="flex-1 overflow-y-auto bg-slate-50 scroll-smooth">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6 sm:py-8">
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 lg:gap-8">
                    
                    <div class="lg:col-span-2 space-y-6">
                        <div class="bg-white rounded-xl shadow-sm border border-slate-100 overflow-visible">
                            <div class="p-4 sm:p-5 border-b border-slate-100 flex justify-between items-center bg-white rounded-t-xl z-20 relative">
                                <h2 class="text-lg font-semibold text-slate-800 flex items-center gap-2">
                                    <i class="ph-duotone ph-package text-indigo-500"></i> Materiais
                                </h2>
                                <div id="valor-materiais" class="text-sm font-bold text-slate-700 bg-slate-100 px-3 py-1.5 rounded-lg">R$ 0,00</div>
                            </div>
                            
                            <div class="p-4 sm:p-6">
                                <table class="w-full text-left border-collapse min-w-[500px] lg:min-w-0">
                                    <thead>
                                        <tr class="text-xs font-bold text-slate-400 uppercase tracking-wider border-b border-slate-100">
                                            <th class="pb-3 pl-1 w-5/12">Item</th>
                                            <th class="pb-3 w-20 text-center">Qtd.</th>
                                            <th class="pb-3 w-28">V. Unit.</th>
                                            <th class="pb-3 w-28 text-right">Total</th>
                                            <th class="pb-3 w-10"></th>
                                        </tr>
                                    </thead>
                                    <tbody id="tabela-body" class="text-sm relative"></tbody>
                                </table>
                                
                                <button id="btn-add-linha" class="mt-6 flex items-center gap-2 text-sm font-medium text-indigo-600 hover:text-indigo-700 hover:bg-indigo-50 px-4 py-3 rounded-xl transition-all w-full justify-center border border-dashed border-indigo-200">
                                    <i class="ph-bold ph-plus"></i> Adicionar Nova Linha
                                </button>
                            </div>
                        </div>
                        
                        <div>
                            <h3 class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-3 ml-1">Orçamentos Salvos (Neste Dispositivo)</h3>
                            <div id="lista-planilhas" class="grid grid-cols-1 md:grid-cols-2 gap-3"></div>
                        </div>
                    </div>

                    <div class="lg:col-span-1">
                        <div class="bg-white rounded-xl shadow-lg border border-indigo-50 p-6 lg:sticky lg:top-6 z-0">
                            <h2 class="text-lg font-semibold text-slate-900 mb-6 flex items-center gap-2">
                                <i class="ph-duotone ph-sliders-horizontal text-indigo-500"></i> Configuração
                            </h2>
                            <div class="space-y-5">
                                <div>
                                    <label class="block text-xs font-bold text-slate-500 mb-1.5 uppercase">Nome do Projeto</label>
                                    <input type="text" id="nome-orcamento" class="w-full border-slate-200 border rounded-lg px-4 py-3 text-slate-900 font-semibold focus:ring-2 focus:ring-indigo-500 bg-slate-50">
                                </div>
                                <div class="grid grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-xs font-bold text-slate-500 mb-1.5 uppercase">Dias</label>
                                        <input type="number" inputmode="decimal" id="dias" placeholder="0" class="w-full border-slate-200 border rounded-lg px-4 py-3 text-slate-900 font-semibold text-center bg-slate-50">
                                    </div>
                                    <div>
                                        <label class="block text-xs font-bold text-slate-500 mb-1.5 uppercase">Diária</label>
                                        <input type="number" inputmode="decimal" id="diaria" placeholder="0" class="w-full border-slate-200 border rounded-lg px-3 py-3 text-slate-900 font-semibold text-right bg-slate-50">
                                    </div>
                                </div>
                                <div>
                                    <label class="block text-xs font-bold text-slate-500 mb-1.5 uppercase">Margem (%)</label>
                                    <input type="number" inputmode="decimal" id="margem-lucro" placeholder="0" class="w-full border-slate-200 border rounded-lg px-4 py-3 text-slate-900 font-semibold focus:ring-2 focus:ring-indigo-500 bg-slate-50">
                                </div>
                                <hr class="border-slate-100 my-2">
                                <div class="text-center bg-indigo-600 rounded-xl p-6 shadow-lg shadow-indigo-200 text-white relative overflow-hidden">
                                    <span class="relative block text-indigo-100 text-sm font-medium mb-1">Preço Final</span>
                                    <span id="resultado-final-valor" class="relative block text-4xl font-extrabold tracking-tight">R$ 0,00</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <div id="backdrop-catalogo" class="fixed inset-0 bg-black/30 z-40 hidden opacity-0 transition-opacity duration-300"></div>

        <div id="drawer-catalogo" class="fixed inset-y-0 right-0 z-50 w-full max-w-sm bg-white shadow-2xl transform translate-x-full transition-transform duration-300 ease-in-out flex flex-col">
            <div class="p-4 border-b border-slate-100 bg-slate-50 flex items-center justify-between">
                <h3 class="font-bold text-lg text-slate-800 flex items-center gap-2">
                    <i class="ph-duotone ph-book-open text-indigo-600"></i> Catálogo Nuvem
                </h3>
                <button id="btn-fechar-catalogo" class="text-slate-400 hover:text-slate-600 p-2"><i class="ph-bold ph-x text-xl"></i></button>
            </div>
            <div class="p-4 bg-white border-b border-slate-100 space-y-3">
                <p class="text-xs font-bold text-slate-400 uppercase">Novo Item</p>
                <div class="flex gap-2">
                    <input type="text" id="cat-nome" placeholder="Ex: Dobradiça Curva" class="flex-1 border border-slate-200 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-indigo-500">
                </div>
                <div class="flex gap-2">
                    <div class="relative flex-1">
                        <span class="absolute left-3 top-2 text-slate-400 text-sm">R$</span>
                        <input type="number" inputmode="decimal" id="cat-preco" placeholder="0,00" class="w-full border border-slate-200 rounded-lg pl-8 pr-3 py-2 text-sm focus:ring-2 focus:ring-indigo-500">
                    </div>
                    <button id="btn-add-catalogo" class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 rounded-lg font-bold text-sm shadow transition flex items-center justify-center min-w-[80px]">
                        SALVAR
                    </button>
                </div>
                <p id="status-catalogo" class="text-[10px] text-slate-400 text-center h-4"></p>
            </div>
            <div class="flex-1 overflow-y-auto p-4 bg-slate-50">
                <div id="lista-catalogo" class="space-y-2">
                    <div class="flex flex-col items-center mt-10 text-slate-400">
                        <div class="loader mb-2"></div>
                        <span class="text-sm">Sincronizando...</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- CONFIGURAÇÃO SUPABASE ---
        const SUPABASE_URL = 'https://yupqupqjflmqhwjroaio.supabase.co'; 
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inl1cHF1cHFqZmxtcWh3anJvYWlvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjYxMDQyNDQsImV4cCI6MjA4MTY4MDI0NH0.EMF1j36peTGEFHZ1rj3DqOMRujPBpZkiBaz0W7RJkRM';
        const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        // --- VARIÁVEIS GLOBAIS ---
        // Nota: Removemos o carregamento do localStorage para o catalogoItens
        let catalogoItens = []; 
        let planilhasSalvas = JSON.parse(localStorage.getItem('marccalc_planilhas')) || {};
        let planilhaAtualId = null;
        let currentUser = null;

        // Elementos
        const viewLogin = document.getElementById('view-login');
        const viewApp = document.getElementById('view-app');
        const msgErro = document.getElementById('msg-erro');
        const btnLoginAction = document.getElementById('btn-login-action');
        const tabelaBody = document.getElementById('tabela-body');
        
        const drawerCatalogo = document.getElementById('drawer-catalogo');
        const backdropCatalogo = document.getElementById('backdrop-catalogo');
        const listaCatalogoEl = document.getElementById('lista-catalogo');
        const inputCatNome = document.getElementById('cat-nome');
        const inputCatPreco = document.getElementById('cat-preco');
        const btnAddCatalogo = document.getElementById('btn-add-catalogo');
        const statusCatalogo = document.getElementById('status-catalogo');

        // --- AUTH & INIT ---
        async function tentarLogin() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            if(!email || !password) return mostrarErro("Preencha todos os campos.");
            
            msgErro.classList.add('hidden');
            btnLoginAction.disabled = true;
            btnLoginAction.innerHTML = '<div class="loader"></div>';

            try {
                const { data, error } = await sb.auth.signInWithPassword({ email, password });
                if (error) throw new Error("Credenciais inválidas.");
                currentUser = data.user;
                mostrarApp();
            } catch (err) {
                mostrarErro(err.message);
                btnLoginAction.disabled = false;
                btnLoginAction.innerHTML = '<span id="btn-text">ENTRAR</span>';
            }
        }

        function mostrarErro(msg) { msgErro.textContent = msg; msgErro.classList.remove('hidden'); }

        async function init() {
            const { data: { session } } = await sb.auth.getSession();
            if (session) {
                currentUser = session.user;
                mostrarApp();
            } else {
                viewLogin.classList.remove('hidden');
            }
        }

        async function logout() {
            await sb.auth.signOut();
            window.location.reload();
        }

        function mostrarApp() {
            viewLogin.classList.add('hidden');
            viewApp.classList.remove('hidden');
            atualizarListaPlanilhas();
            
            // CARREGAR CATÁLOGO DA NUVEM ASSIM QUE ENTRAR
            carregarCatalogoDoBanco();
            
            if(Object.keys(planilhasSalvas).length === 0 && !planilhaAtualId) novaPlanilha();
        }

        // --- LÓGICA DO CATÁLOGO NA NUVEM (SUPABASE) ---

        // 1. Ler (Select)
        async function carregarCatalogoDoBanco() {
            if(!currentUser) return;
            
            // Busca na tabela 'catalog_items'
            const { data, error } = await sb
                .from('catalog_items')
                .select('*')
                .order('nome', { ascending: true });

            if (error) {
                console.error("Erro ao carregar catálogo:", error);
                listaCatalogoEl.innerHTML = '<div class="text-red-500 text-center text-sm">Erro de conexão.</div>';
                return;
            }

            catalogoItens = data || []; // Atualiza a variável global (cache em memória)
            renderizarCatalogoVisual();
        }

        // 2. Criar (Insert)
        async function addAoCatalogo() {
            const nome = inputCatNome.value.trim();
            const preco = parseFloat(inputCatPreco.value.replace(',','.')) || 0;

            if(!nome) return alert("Digite o nome.");

            // UI Loading
            const btnTextoOriginal = btnAddCatalogo.innerHTML;
            btnAddCatalogo.disabled = true;
            btnAddCatalogo.innerHTML = '<div class="loader border-white"></div>';

            // Insert no Banco
            const { data, error } = await sb
                .from('catalog_items')
                .insert([{ user_id: currentUser.id, nome: nome, preco: preco }])
                .select(); // O .select() retorna o item criado com o ID gerado pelo banco

            if (error) {
                alert("Erro ao salvar: " + error.message);
            } else {
                // Sucesso: Adiciona ao array local e limpa inputs
                catalogoItens.push(data[0]);
                inputCatNome.value = '';
                inputCatPreco.value = '';
                inputCatNome.focus();
                statusCatalogo.textContent = "Item salvo na nuvem!";
                setTimeout(() => statusCatalogo.textContent = "", 2000);
                
                // Re-renderiza a lista visual
                renderizarCatalogoVisual();
            }

            btnAddCatalogo.disabled = false;
            btnAddCatalogo.innerHTML = btnTextoOriginal;
        }

        // 3. Deletar (Delete)
        async function deletarDoCatalogo(idDoItem) {
            if(!confirm("Remover este item do banco de dados?")) return;

            // Remove visualmente primeiro (Otimista)
            const itemElement = document.getElementById(`item-${idDoItem}`);
            if(itemElement) itemElement.style.opacity = '0.5';

            const { error } = await sb
                .from('catalog_items')
                .delete()
                .eq('id', idDoItem);

            if (error) {
                alert("Erro ao deletar: " + error.message);
                if(itemElement) itemElement.style.opacity = '1'; // Restaura se der erro
            } else {
                // Atualiza array local
                catalogoItens = catalogoItens.filter(i => i.id !== idDoItem);
                renderizarCatalogoVisual();
            }
        }

        function renderizarCatalogoVisual() {
            listaCatalogoEl.innerHTML = '';

            if(catalogoItens.length === 0) {
                listaCatalogoEl.innerHTML = '<div class="text-center text-slate-400 text-sm mt-10">Catálogo vazio.</div>';
                return;
            }

            // Ordena localmente para garantir
            catalogoItens.sort((a,b) => a.nome.localeCompare(b.nome));

            catalogoItens.forEach(item => {
                const div = document.createElement('div');
                div.id = `item-${item.id}`;
                div.className = "bg-white border border-slate-200 rounded-lg p-3 flex justify-between items-center shadow-sm hover:shadow-md transition group";
                div.innerHTML = `
                    <div class="flex-1 overflow-hidden">
                        <div class="font-semibold text-slate-700 truncate text-sm">${item.nome}</div>
                        <div class="text-xs text-slate-500 font-mono">R$ ${parseFloat(item.preco).toFixed(2)}</div>
                    </div>
                    <button class="btn-del-item text-slate-300 hover:text-red-500 p-2 rounded-lg transition">
                        <i class="ph-bold ph-trash"></i>
                    </button>
                `;

                // Linkando o botão de deletar com o ID do banco
                div.querySelector('.btn-del-item').onclick = () => deletarDoCatalogo(item.id);
                
                listaCatalogoEl.appendChild(div);
            });
        }


        // --- UI E LÓGICA DA CALCULADORA (IGUAL AO ANTERIOR, MAS USANDO catalogoItens ATUALIZADO) ---
        
        function formatarMoeda(valor) {
            return `R$ ${valor.toFixed(2).replace('.', ',').replace(/\B(?=(\d{3})+(?!\d))/g, '.')}`;
        }

        function adicionarLinha(material = '', qty = '', unit = '') {
            const tr = document.createElement('tr');
            tr.className = "group hover:bg-slate-50 border-b border-slate-50 relative";
            
            tr.innerHTML = `
                <td class="py-2 pr-2 pl-1 relative align-top">
                    <div class="relative w-full">
                        <input type="text" value="${material}" class="input-material w-full border border-slate-200 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-indigo-500 z-10 relative bg-white" placeholder="Nome do item..." autocomplete="off">
                        <ul class="dropdown-list absolute z-50 left-0 w-full bg-white border border-slate-200 rounded-lg shadow-xl mt-1 max-h-0 opacity-0 overflow-hidden transition-all duration-300 ease-in-out custom-scrollbar top-full"></ul>
                    </div>
                </td>
                <td class="py-2 pr-2 align-top"><input type="number" inputmode="decimal" value="${qty}" class="input-qty w-full border border-slate-200 rounded-lg px-2 py-2 text-center text-sm bg-slate-50 focus:bg-white transition-colors" placeholder="0"></td>
                <td class="py-2 pr-2 align-top"><input type="number" inputmode="decimal" step="0.01" value="${unit}" class="input-unit w-full border border-slate-200 rounded-lg px-3 py-2 text-sm"></td>
                <td class="py-2 text-right font-medium text-sm total-cell align-top pt-3">R$ 0,00</td>
                <td class="py-2 text-right align-top"><button class="btn-remove text-slate-300 hover:text-red-500 p-2"><i class="ph-bold ph-trash"></i></button></td>
            `;

            const inputMaterial = tr.querySelector('.input-material');
            const ulList = tr.querySelector('.dropdown-list');
            const inputQty = tr.querySelector('.input-qty');
            const inputUnit = tr.querySelector('.input-unit');

            // --- Lógica Dropdown (Usa a var catalogoItens que veio do Supabase) ---
            const abrirLista = () => {
                const filtro = inputMaterial.value.toLowerCase();
                ulList.innerHTML = '';
                
                const filtrados = catalogoItens.filter(i => i.nome.toLowerCase().includes(filtro));

                if (filtrados.length === 0 && !filtro && catalogoItens.length === 0) return; // Nada para mostrar

                if (filtrados.length === 0 && filtro) {
                    ulList.innerHTML = '<li class="p-3 text-xs text-slate-400 text-center">Nenhum item encontrado</li>';
                } else {
                    filtrados.forEach(item => {
                        const li = document.createElement('li');
                        li.className = "px-3 py-2 text-sm hover:bg-indigo-50 cursor-pointer border-b border-slate-50 flex justify-between";
                        li.innerHTML = `<span>${item.nome}</span> <span class="text-xs text-slate-400">R$ ${parseFloat(item.preco).toFixed(2)}</span>`;
                        li.onmousedown = (e) => {
                            e.preventDefault();
                            inputMaterial.value = item.nome;
                            inputUnit.value = item.preco;
                            calcularLinha(tr);
                            updateGeral();
                            fecharLista();
                            inputQty.focus();
                        };
                        ulList.appendChild(li);
                    });
                }
                ulList.classList.remove('max-h-0', 'opacity-0');
                ulList.classList.add('max-h-60', 'opacity-100', 'overflow-y-auto');
            };

            const fecharLista = () => {
                ulList.classList.remove('max-h-60', 'opacity-100', 'overflow-y-auto');
                ulList.classList.add('max-h-0', 'opacity-0', 'overflow-hidden');
            };

            inputMaterial.addEventListener('focus', abrirLista);
            inputMaterial.addEventListener('input', () => { abrirLista(); calcularLinha(tr); });
            inputMaterial.addEventListener('blur', () => setTimeout(fecharLista, 200));

            [inputQty, inputUnit].forEach(i => i.addEventListener('input', () => { calcularLinha(tr); updateGeral(); }));
            tr.querySelector('.btn-remove').onclick = () => { tr.remove(); updateGeral(); };

            tabelaBody.appendChild(tr);
            if(qty && unit) calcularLinha(tr);
        }

        function calcularLinha(tr) {
            const q = parseFloat(tr.querySelector('.input-qty').value.replace(',','.')) || 0;
            const u = parseFloat(tr.querySelector('.input-unit').value.replace(',','.')) || 0;
            tr.querySelector('.total-cell').textContent = formatarMoeda(q * u);
            tr.querySelector('.total-cell').dataset.value = q * u;
        }

        function updateGeral() {
            let totalMat = 0;
            document.querySelectorAll('.total-cell').forEach(c => totalMat += parseFloat(c.dataset.value) || 0);
            document.getElementById('valor-materiais').textContent = formatarMoeda(totalMat);
            
            const dias = parseFloat(document.getElementById('dias').value) || 0;
            const diaria = parseFloat(document.getElementById('diaria').value) || 0;
            const margem = parseFloat(document.getElementById('margem-lucro').value) || 0;
            
            const custo = totalMat + (dias * diaria);
            const final = custo + (custo * (margem / 100));
            document.getElementById('resultado-final-valor').textContent = formatarMoeda(final);
            salvarPlanilhaLocal(); // Ainda salvando a PLANILHA localmente por enquanto
        }

        // --- SALVAMENTO DE PLANILHAS (LOCAL POR ENQUANTO) ---
        function salvarPlanilhaLocal() {
            if (!planilhaAtualId) planilhaAtualId = 'planilha_' + Date.now();
            const dados = {
                id: planilhaAtualId,
                nome: document.getElementById('nome-orcamento').value || "Sem Nome",
                data: new Date().toISOString(),
                dias: document.getElementById('dias').value,
                diaria: document.getElementById('diaria').value,
                margem: document.getElementById('margem-lucro').value,
                materiais: []
            };
            document.querySelectorAll('#tabela-body tr').forEach(tr => {
                dados.materiais.push({
                    nome: tr.querySelector('.input-material').value,
                    qtd: tr.querySelector('.input-qty').value,
                    unit: tr.querySelector('.input-unit').value
                });
            });
            planilhasSalvas[planilhaAtualId] = dados;
            localStorage.setItem('marccalc_planilhas', JSON.stringify(planilhasSalvas));
            atualizarListaPlanilhas();
        }

        function novaPlanilha() {
            tabelaBody.innerHTML = '';
            ['dias', 'diaria', 'margem-lucro', 'nome-orcamento'].forEach(id => document.getElementById(id).value = '');
            document.getElementById('resultado-final-valor').textContent = 'R$ 0,00';
            document.getElementById('valor-materiais').textContent = 'R$ 0,00';
            planilhaAtualId = null;
            for(let i=0; i<3; i++) adicionarLinha();
        }

        function carregarPlanilha(id) {
            const p = planilhasSalvas[id];
            if(!p) return;
            planilhaAtualId = id;
            tabelaBody.innerHTML = '';
            document.getElementById('nome-orcamento').value = p.nome;
            document.getElementById('dias').value = p.dias;
            document.getElementById('diaria').value = p.diaria;
            document.getElementById('margem-lucro').value = p.margem;
            if(p.materiais) p.materiais.forEach(m => adicionarLinha(m.nome, m.qtd, m.unit));
            updateGeral();
        }

        function atualizarListaPlanilhas() {
            const container = document.getElementById('lista-planilhas');
            container.innerHTML = '';
            Object.values(planilhasSalvas).sort((a,b) => new Date(b.data) - new Date(a.data)).forEach(p => {
                const div = document.createElement('div');
                div.className = "p-3 rounded-xl border cursor-pointer bg-white border-slate-200 hover:border-indigo-300 flex justify-between items-center";
                div.innerHTML = `
                    <div onclick="carregarPlanilha('${p.id}')" class="flex-1">
                        <div class="font-bold text-sm truncate">${p.nome}</div>
                        <div class="text-xs text-slate-500">${new Date(p.data).toLocaleDateString()}</div>
                    </div>
                    <button class="text-slate-300 hover:text-red-500 p-2" onclick="excluirPlanilha('${p.id}')"><i class="ph-bold ph-trash"></i></button>
                `;
                container.appendChild(div);
            });
        }
        
        function excluirPlanilha(id) {
            if(confirm("Excluir?")) { delete planilhasSalvas[id]; localStorage.setItem('marccalc_planilhas', JSON.stringify(planilhasSalvas)); if(planilhaAtualId==id) novaPlanilha(); atualizarListaPlanilhas(); }
        }

        // --- DRAWER CONTROLLER ---
        function toggleCatalogo() {
            const drawer = document.getElementById('drawer-catalogo');
            const backdrop = document.getElementById('backdrop-catalogo');
            const isHidden = drawer.classList.contains('translate-x-full');

            if (isHidden) {
                backdrop.classList.remove('hidden');
                setTimeout(() => { backdrop.classList.remove('opacity-0'); drawer.classList.remove('translate-x-full'); drawer.classList.add('translate-x-0'); }, 10);
                setTimeout(() => inputCatNome.focus(), 300);
            } else {
                drawer.classList.remove('translate-x-0'); drawer.classList.add('translate-x-full'); backdrop.classList.add('opacity-0');
                setTimeout(() => { backdrop.classList.add('hidden'); }, 300);
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            btnLoginAction.addEventListener('click', tentarLogin);
            document.getElementById('btn-novo').addEventListener('click', novaPlanilha);
            document.getElementById('btn-logout').addEventListener('click', logout);
            document.getElementById('btn-add-linha').addEventListener('click', () => adicionarLinha());
            
            document.getElementById('btn-abrir-catalogo').addEventListener('click', toggleCatalogo);
            document.getElementById('btn-fechar-catalogo').addEventListener('click', toggleCatalogo);
            document.getElementById('backdrop-catalogo').addEventListener('click', toggleCatalogo);
            document.getElementById('btn-add-catalogo').addEventListener('click', addAoCatalogo);
            
            inputCatPreco.addEventListener('keypress', (e) => { if(e.key === 'Enter') addAoCatalogo(); });
            ['nome-orcamento', 'margem-lucro', 'dias', 'diaria'].forEach(id => document.getElementById(id).addEventListener('input', updateGeral));
            
            init();
        });
    </script>
</body>
</html>
